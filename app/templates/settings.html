{% extends "base.html" %}

{% block title %}Settings - Nexum Mesh Messaging{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900">Settings</h2>
        <p class="mt-2 text-sm text-gray-600">Configure your profile and preferences</p>
    </div>

    <div class="max-w-2xl">
        <!-- User Name Configuration -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Profile</h3>
            <div class="space-y-4">
                <div>
                    <label for="userNameInput" class="block text-sm font-medium text-gray-700 mb-2">
                        Your Name
                    </label>
                    <input 
                        type="text" 
                        id="userNameInput" 
                        placeholder="Enter your name (optional)"
                        class="w-full rounded-md border-gray-300 shadow-sm p-2 border focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="mt-1 text-xs text-gray-500">
                        Your name will be included in location broadcasts for identification.
                    </p>
                </div>
                
                <div>
                    <button 
                        onclick="saveUserName()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
                    >
                        Save Name
                    </button>
                    <button 
                        onclick="clearUserName()"
                        class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition-colors"
                    >
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- User Type Configuration -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">User Type</h3>
            <div class="space-y-4">
                <div>
                    <label for="settingsUserTypeSwitch" class="block text-sm font-medium text-gray-700 mb-2">
                        Select your role
                    </label>
                    <select 
                        id="settingsUserTypeSwitch" 
                        class="w-full rounded-md border-gray-300 shadow-sm p-2 border focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="responder">Responder</option>
                        <option value="civilian">Civilian</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">
                        This determines how your location broadcasts are categorized in the network.
                    </p>
                </div>
            </div>
        </div>

        <!-- User UUID Display (Read-only) -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">User Information</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        User UUID
                    </label>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            id="userUuidDisplay" 
                            readonly
                            class="flex-1 rounded-md border-gray-300 bg-gray-100 p-2 border text-sm font-mono"
                        />
                        <button 
                            onclick="copyUUID()"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-xs font-medium transition-colors"
                            title="Copy to clipboard"
                        >
                            Copy
                        </button>
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        Your unique identifier in the network. This is automatically generated.
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Actions</h3>
            <div class="space-y-2">
                <button 
                    onclick="resetUserUUID()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors"
                >
                    Generate New UUID
                </button>
                <p class="text-xs text-gray-500 mt-2">
                    Warning: Generating a new UUID will create a new identity. Your previous location history will not be linked to this new UUID.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function() {
        // Load current name
        if (typeof LocationSender !== 'undefined') {
            const currentName = LocationSender.getUserName();
            const userNameInput = document.getElementById('userNameInput');
            if (userNameInput && currentName) {
                userNameInput.value = currentName;
            }
            
            // Load current user type
            const currentRole = LocationSender.getUserRole();
            const userTypeSwitch = document.getElementById('settingsUserTypeSwitch');
            if (userTypeSwitch) {
                userTypeSwitch.value = currentRole;
            }
            
            // Display UUID
            const userUuid = LocationSender.getUserUUID();
            const uuidDisplay = document.getElementById('userUuidDisplay');
            if (uuidDisplay) {
                uuidDisplay.value = userUuid;
            }
        }
        
        // Sync settings user type switch with header switch
        const settingsSwitch = document.getElementById('settingsUserTypeSwitch');
        const headerSwitch = document.getElementById('headerUserTypeSwitch');
        
        if (settingsSwitch && headerSwitch) {
            // Sync from settings to header
            settingsSwitch.addEventListener('change', function() {
                headerSwitch.value = this.value;
                if (typeof HeaderControls !== 'undefined' && HeaderControls.setUserType) {
                    HeaderControls.setUserType(this.value);
                }
                if (typeof LocationSender !== 'undefined') {
                    LocationSender.setUserRole(this.value);
                }
            });
        }
    });
    
    // Save user name
    function saveUserName() {
        const userNameInput = document.getElementById('userNameInput');
        if (!userNameInput) return;
        
        const name = userNameInput.value.trim();
        
        if (typeof LocationSender !== 'undefined') {
            LocationSender.setUserName(name);
            
            if (name) {
                alert('Name saved successfully!');
            } else {
                alert('Name cleared.');
            }
        } else {
            alert('Location sender not loaded. Please refresh the page.');
        }
    }
    
    // Clear user name
    function clearUserName() {
        const userNameInput = document.getElementById('userNameInput');
        if (userNameInput) {
            userNameInput.value = '';
        }
        saveUserName();
    }
    
    // Copy UUID to clipboard
    function copyUUID() {
        const uuidDisplay = document.getElementById('userUuidDisplay');
        if (!uuidDisplay) return;
        
        uuidDisplay.select();
        uuidDisplay.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            document.execCommand('copy');
            alert('UUID copied to clipboard!');
        } catch (err) {
            // Fallback for modern browsers
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(uuidDisplay.value).then(function() {
                    alert('UUID copied to clipboard!');
                });
            } else {
                alert('Could not copy UUID. Please select and copy manually.');
            }
        }
    }
    
    // Reset user UUID
    function resetUserUUID() {
        if (!confirm('Are you sure you want to generate a new UUID? This will create a new identity.')) {
            return;
        }
        
        if (typeof LocationSender !== 'undefined') {
            // Generate new UUID
            const newUuid = LocationSender.generateUUID();
            localStorage.setItem('user_uuid', newUuid);
            
            // Update display
            const uuidDisplay = document.getElementById('userUuidDisplay');
            if (uuidDisplay) {
                uuidDisplay.value = newUuid;
            }
            
            alert('New UUID generated successfully!');
        } else {
            alert('Location sender not loaded. Please refresh the page.');
        }
    }
</script>
{% endblock %}

