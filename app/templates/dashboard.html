{% extends "base.html" %}

{% block title %}Dashboard - Nexum Mesh Messaging{% endblock %}

{% block extra_css %}
<style>
    #dashboard-map {
        width: 100% !important;
        height: calc(100vh - 200px) !important;
        min-height: 600px !important;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        position: relative;
    }
    
    /* Drawer open state */
    #map-controls-drawer.drawer-open {
        transform: translateY(0);
    }
    
    #drawer-backdrop.backdrop-visible {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Mesh Network Dashboard</h2>
        <p class="mt-2 text-sm text-gray-600">View and manage location data from mesh network nodes</p>
    </div>

    <!-- Map Container -->
    <div class="bg-white shadow rounded-lg p-4 relative">
        <!-- Status Bar -->
        <div id="status-bar" class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between gap-4">
                <div id="status-bar-content" class="flex flex-wrap items-center gap-4 md:gap-6 flex-1">
                    <!-- Status items will be dynamically inserted here -->
                    <div class="text-sm text-gray-500">Loading...</div>
                </div>
                
                <!-- Config Button -->
                <button 
                    id="open-controls-btn" 
                    class="flex-shrink-0 bg-blue-600 text-white p-2 rounded-lg shadow hover:bg-blue-700 transition-colors"
                    aria-label="Open map controls"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="dashboard-map" style="position: relative; width: 100%; height: calc(100vh - 200px); min-height: 600px;">
        </div>
    </div>
    
    <!-- Bottom Drawer -->
    <div id="map-controls-drawer" class="fixed inset-x-0 bottom-0 bg-white rounded-t-xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out z-50 max-h-[85vh] overflow-y-auto">
        <div class="p-3">
            <!-- Drawer Handle -->
            <div class="flex justify-center mb-3">
                <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
            </div>
            
            <!-- Map Controls Content -->
            {% set map_id = 'default' %}
            {% include 'components/map_control.html' %}
        </div>
    </div>
    
    <!-- Drawer Backdrop -->
    <div id="drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-40"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load MapLibre GL JS first -->
<script src="{{ url_for('static', filename='maplibre-gl.js') }}"></script>
<script type="module">
    (async function() {
        // Wait for maplibregl if not yet available
        while (typeof maplibregl === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        const { initMap } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { initMapControl } = await import("{{ url_for('static', filename='map-control.js') }}");
        const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { getLocationStats } = await import("{{ url_for('static', filename='location-reader.js') }}");
        
        // Update status bar with entity counts
        async function updateStatusBar() {
            try {
                const stats = await getLocationStats();
                const statusBar = document.getElementById('status-bar');
                const counts = stats.by_entity_type || {};
                
                // Entity types with their display names and icons
                const entityTypes = [
                    { type: 'responder', label: 'Responder', icon: '/assets/images/responder.png' },
                    { type: 'civilian', label: 'Civilian', icon: '/assets/images/civilian.png' },
                    { type: 'incident', label: 'Incident', icon: '/assets/images/incident.png' },
                    { type: 'resource', label: 'Resource', icon: '/assets/images/resource.png' },
                    { type: 'hazard', label: 'Hazard', icon: '/assets/images/hazard.png' }
                ];
                
                // Build status bar HTML
                const items = entityTypes.map(entity => {
                    const count = counts[entity.type] || 0;
                    return `
                        <div class="flex items-center gap-2">
                            <img src="${entity.icon}" alt="${entity.label}" class="w-5 h-5 object-contain" />
                            <span class="hidden md:inline font-medium text-gray-900">${entity.label}</span>
                            <span class="text-gray-600 font-medium">${count}</span>
                        </div>
                    `;
                }).join('');
                
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = items || '<div class="text-sm text-gray-500">No locations found</div>';
                }
                
            } catch (error) {
                console.error('Error updating status bar:', error);
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = '<div class="text-sm text-red-500">Error loading status</div>';
                }
            }
        }
        
        // Make updateStatusBar globally accessible so map control can call it
        window.updateStatusBar = updateStatusBar;
        
        try {
            // Initial status bar update
            await updateStatusBar();
            // Initialize map with mapId
            const mapInstance = await initMap({
                containerId: 'dashboard-map',
                showControls: true,
                mapId: 'dashboard-map'
            });
            
            // Drawer controls
            const drawer = document.getElementById('map-controls-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            const openBtn = document.getElementById('open-controls-btn');
            
            function openDrawer() {
                drawer.classList.add('drawer-open');
                backdrop.classList.add('backdrop-visible');
                document.body.style.overflow = 'hidden';
            }
            
            function closeDrawer() {
                drawer.classList.remove('drawer-open');
                backdrop.classList.remove('backdrop-visible');
                document.body.style.overflow = '';
            }
            
            openBtn.addEventListener('click', openDrawer);
            backdrop.addEventListener('click', closeDrawer);
            
            // Close drawer button (inside drawer)
            const closeBtn = document.getElementById('close-drawer-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeDrawer);
            }
            
            // Close drawer on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && drawer.classList.contains('drawer-open')) {
                    closeDrawer();
                }
            });
            
            // Wait for map to load
            mapInstance.once('load', async () => {
                console.log('Map loaded, initializing map controls...');
                // Initialize map control (component already rendered in template)
                await initMapControl('default', mapInstance);
                
                // Initial refresh
                await refreshMapMarkers(mapInstance, 'default');
                
                // Update status bar after refresh
                await updateStatusBar();
                
                // Start automatic map refresh every 5 seconds
                console.log('[MapRefresh] Starting automatic map refresh (interval: 5s)');
                let mapRefreshInterval = setInterval(async () => {
                    try {
                        console.log('[MapRefresh] Automatic refresh triggered');
                        await refreshMapMarkers(mapInstance, 'default');
                        // Update status bar after refresh
                        if (typeof updateStatusBar === 'function') {
                            await updateStatusBar();
                        }
                    } catch (error) {
                        console.error('[MapRefresh] Error during automatic refresh:', error);
                    }
                }, 5000); // 5 seconds
                
                // Store interval ID for potential cleanup
                window.mapRefreshInterval = mapRefreshInterval;
            });
            
            // Cleanup interval on page unload
            window.addEventListener('beforeunload', () => {
                if (window.mapRefreshInterval) {
                    console.log('[MapRefresh] Stopping automatic map refresh');
                    clearInterval(window.mapRefreshInterval);
                    window.mapRefreshInterval = null;
                }
            });
           
            
        } catch (error) {
            console.error('Error initializing dashboard map:', error);
            document.getElementById('dashboard-map').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444;">' +
                'Error loading map: ' + error.message +
                '</div>';
        }
    })();
</script>
{% endblock %}

