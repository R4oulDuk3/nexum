{% extends "base.html" %}

{% block title %}Dashboard - Nexum Mesh Messaging{% endblock %}

{% block extra_css %}
<style>
    #dashboard-map {
        width: 100% !important;
        height: calc(100vh - 200px) !important;
        min-height: 600px !important;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        position: relative;
    }
    
    /* Drawer open state */
    #map-controls-drawer.drawer-open {
        transform: translateY(0);
    }
    
    #drawer-backdrop.backdrop-visible {
        opacity: 1;
        pointer-events: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Mesh Network Dashboard</h2>
        <p class="mt-2 text-sm text-gray-500">View and manage location data from mesh network nodes</p>
    </div>

    <!-- GPS Broadcast Button -->
    <div class="mb-4 flex justify-center">
        <button 
            id="gps-broadcast-btn" 
            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium shadow-sm transition-colors hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2"
        >
            <svg id="gps-broadcast-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span id="gps-broadcast-text">Start GPS Broadcasting</span>
        </button>
    </div>

    <!-- Map Container -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 relative shadow-sm">
        <!-- Status Bar -->
        <div id="status-bar" class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between gap-4">
                <div id="status-bar-content" class="flex flex-wrap items-center gap-4 md:gap-6 flex-1">
                    <!-- Status items will be dynamically inserted here -->
                    <div class="text-sm text-gray-500">Loading...</div>
                </div>
                
                <!-- Config Button -->
                <button 
                    id="open-controls-btn" 
                    class="flex-shrink-0 rounded-md bg-teal-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-teal-700"
                    aria-label="Open map controls"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div id="dashboard-map" style="position: relative; width: 100%; height: calc(100vh - 200px); min-height: 600px;">
        </div>
    </div>
    
    <!-- Debug Section -->
    <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="text-sm font-semibold text-gray-600 mb-2">Debug</div>
        <div class="flex gap-2 flex-wrap">
            <button 
                id="sync-btn-default" 
                class="px-4 py-2 bg-purple-600 text-white border-none rounded-md text-sm font-medium cursor-pointer transition-colors hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-wait"
            >
                Sync from Server
            </button>
            <button 
                id="deepSyncButton" 
                onclick="triggerDeepSync()"
                class="px-4 py-2 bg-purple-600 text-white border-none rounded-md text-sm font-medium cursor-pointer transition-colors hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-wait"
            >
                Deep Sync (Last 3 Hours)
            </button>
            <button 
                id="clearDbButton" 
                onclick="clearLocalState()"
                class="px-4 py-2 bg-red-600 text-white border-none rounded-md text-sm font-medium cursor-pointer transition-colors hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-wait"
            >
                Clear Local State
            </button>
        </div>
        <div id="debugProgress" class="mt-3 p-3 bg-white border border-gray-300 rounded-lg hidden">
            <div class="flex items-center mb-2">
                <span id="debugStatus" class="text-sm font-medium">Processing...</span>
            </div>
            <div id="debugDetails" class="text-sm text-gray-600"></div>
        </div>
    </div>
    
    <!-- Bottom Drawer -->
    <div id="map-controls-drawer" class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow-2xl border-t border-gray-200 transform translate-y-full transition-transform duration-300 ease-out z-50 max-h-[85vh] overflow-y-auto">
        <div class="p-4">
            <!-- Drawer Handle -->
            <div class="flex justify-center mb-4">
                <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
            </div>
            
            <!-- Map Controls Content -->
            {% set map_id = 'default' %}
            {% include 'components/map_control.html' %}
        </div>
    </div>
    
    <!-- Drawer Backdrop -->
    <div id="drawer-backdrop" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity duration-300 z-40"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load MapLibre GL JS first -->
<script src="{{ url_for('static', filename='maplibre-gl.js') }}"></script>
<script type="module">
    (async function() {
        console.log('[Dashboard] Starting dashboard initialization...');
        
        // Ensure DOM is fully ready
        if (document.readyState === 'loading') {
            console.log('[Dashboard] DOM still loading, waiting for DOMContentLoaded...');
            await new Promise((resolve) => {
                document.addEventListener('DOMContentLoaded', resolve);
            });
        }
        console.log('[Dashboard] DOM is ready (state: ' + document.readyState + ')');
        
        // Wait for maplibregl if not yet available
        while (typeof maplibregl === 'undefined') {
            console.log('[Dashboard] Waiting for maplibregl to be available...');
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        console.log('[Dashboard] maplibregl is available');
        
        const { initMap } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { initMapControl } = await import("{{ url_for('static', filename='map-control.js') }}");
        const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { getLocationsGroupedByEntity } = await import("{{ url_for('static', filename='location-reader.js') }}");
        const { getMapConfig } = await import("{{ url_for('static', filename='map-config.js') }}");
        const { deepSyncAllNodes } = await import("{{ url_for('static', filename='location-sync.js') }}");
        const dbModule = await import("{{ url_for('static', filename='location-sync-db.js') }}");
        const db = dbModule.default;
        console.log('[Dashboard] All modules imported successfully');
        
        // Update status bar with entity counts using same filters as map
        async function updateStatusBar() {
            try {
                // Get map config to use same filters as map
                const mapId = window.mapId || 'default';
                const config = await getMapConfig(mapId);
                
                // Use same filters as refreshMapMarkers
                const entityTypes = config ? (config.entity_types_to_show || []) : ['responder', 'civilian', 'incident', 'resource', 'hazard'];
                const timeFromMinutes = config ? (config.time_from_minutes !== undefined ? config.time_from_minutes : -120) : -120;
                const timeUntilMinutes = config ? (config.time_until_minutes !== undefined ? config.time_until_minutes : 0) : 0;
                
                // Get filtered locations using same method as map
                const { latestLocations } = await getLocationsGroupedByEntity(entityTypes, timeFromMinutes, timeUntilMinutes);
                
                // Count by entity type from filtered locations
                const counts = {};
                latestLocations.forEach(loc => {
                    counts[loc.entity_type] = (counts[loc.entity_type] || 0) + 1;
                });
                
                const statusBar = document.getElementById('status-bar');
                
                // Entity types with their display names and icons
                const entityTypeDisplay = [
                    { type: 'responder', label: 'Responder', icon: '/assets/images/responder.png' },
                    { type: 'civilian', label: 'Civilian', icon: '/assets/images/civilian.png' },
                    { type: 'incident', label: 'Incident', icon: '/assets/images/incident.png' },
                    { type: 'resource', label: 'Resource', icon: '/assets/images/resource.png' },
                    { type: 'hazard', label: 'Hazard', icon: '/assets/images/hazard.png' }
                ];
                
                // Build status bar HTML - only show entity types that are enabled in config
                const items = entityTypeDisplay
                    .filter(entity => entityTypes.includes(entity.type))
                    .map(entity => {
                        const count = counts[entity.type] || 0;
                        return `
                            <div class="flex items-center gap-2">
                                <img src="${entity.icon}" alt="${entity.label}" class="w-5 h-5 object-contain" />
                                <span class="hidden md:inline font-medium text-gray-900">${entity.label}</span>
                                <span class="text-gray-600 font-medium">${count}</span>
                            </div>
                        `;
                    }).join('');
                
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = items || '<div class="text-sm text-gray-500">No locations found</div>';
                }
                
            } catch (error) {
                console.error('[Dashboard] Error updating status bar:', error);
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = '<div class="text-sm text-red-500">Error loading status</div>';
                }
            }
        }
        
        // Make updateStatusBar globally accessible so map control can call it
        window.updateStatusBar = updateStatusBar;
        
        // Retry helper function
        async function initWithRetry(fn, maxRetries = 1, delay = 1000, context = '') {
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i < maxRetries) {
                        console.warn(`[Dashboard] ${context} Retry ${i + 1}/${maxRetries} after ${delay}ms...`, error);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error(`[Dashboard] ${context} Failed after ${maxRetries} retries:`, error);
                        throw error;
                    }
                }
            }
        }
        
        try {
            // Use consistent mapId - 'default' to match template
            const mapId = 'default';
            console.log(`[Dashboard] Using mapId: ${mapId}`);
            
            // Store mapId globally for debug functions
            window.mapId = mapId;
            
            // Initial status bar update
            console.log('[Dashboard] Performing initial status bar update...');
            await updateStatusBar();
            
            // Initialize map with consistent mapId
            console.log(`[Dashboard] Initializing map with mapId: ${mapId}...`);
            const mapInstance = await initMap({
                containerId: 'dashboard-map',
                showControls: true,
                mapId: mapId
            });
            console.log('[Dashboard] Map instance created successfully');
            
            // Store mapInstance globally for debug functions
            window.mapInstance = mapInstance;
            
            // Verify and setup drawer controls with defensive checks
            console.log('[Dashboard] Setting up drawer controls...');
            const drawer = document.getElementById('map-controls-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            const openBtn = document.getElementById('open-controls-btn');
            
            if (!drawer) {
                console.warn('[Dashboard] Drawer element not found!');
            }
            if (!backdrop) {
                console.warn('[Dashboard] Backdrop element not found!');
            }
            if (!openBtn) {
                console.warn('[Dashboard] Open button element not found!');
            }
            
            function openDrawer() {
                if (!drawer || !backdrop) {
                    console.error('[Dashboard] Cannot open drawer: elements not found');
                    return;
                }
                drawer.classList.add('drawer-open');
                backdrop.classList.add('backdrop-visible');
                document.body.style.overflow = 'hidden';
            }
            
            function closeDrawer() {
                if (!drawer || !backdrop) {
                    console.error('[Dashboard] Cannot close drawer: elements not found');
                    return;
                }
                drawer.classList.remove('drawer-open');
                backdrop.classList.remove('backdrop-visible');
                document.body.style.overflow = '';
            }
            
            if (openBtn) {
                openBtn.addEventListener('click', openDrawer);
                console.log('[Dashboard] Open button event listener attached');
            }
            if (backdrop) {
                backdrop.addEventListener('click', closeDrawer);
                console.log('[Dashboard] Backdrop event listener attached');
            }
            
            // Close drawer button (inside drawer)
            const closeBtn = document.getElementById('close-drawer-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeDrawer);
                console.log('[Dashboard] Close button event listener attached');
            } else {
                console.warn('[Dashboard] Close button not found');
            }
            
            // Close drawer on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && drawer && drawer.classList.contains('drawer-open')) {
                    closeDrawer();
                }
            });
            
            // Initialize map features - handles both already-loaded and not-yet-loaded maps
            async function initializeMapFeatures() {
                console.log(`[Dashboard] Initializing map features for mapId: ${mapId}...`);
                
                // Check if map is already loaded
                const isMapLoaded = mapInstance.loaded();
                console.log(`[Dashboard] Map loaded state: ${isMapLoaded}`);
                
                if (isMapLoaded) {
                    console.log(`[Dashboard] Map already loaded, initializing features immediately`);
                    await initMapFeatures();
                } else {
                    console.log(`[Dashboard] Map not yet loaded, waiting for load event with timeout...`);
                    // Wait for map to load with timeout
                    const loadPromise = new Promise((resolve) => {
                        mapInstance.once('load', () => {
                            console.log('[Dashboard] Map load event fired');
                            resolve();
                        });
                    });
                    
                    const timeoutPromise = new Promise((resolve) => {
                        setTimeout(() => {
                            console.warn(`[Dashboard] Map load timeout (5s), attempting initialization anyway`);
                            resolve();
                        }, 5000); // 5 second timeout
                    });
                    
                    await Promise.race([loadPromise, timeoutPromise]);
                    console.log('[Dashboard] Map load wait completed, initializing features...');
                    await initMapFeatures();
                }
            }
            
            async function initMapFeatures() {
                try {
                    // Verify map control element exists
                    const mapControlElement = document.getElementById(`map-control-${mapId}`);
                    if (!mapControlElement) {
                        throw new Error(`Map control element with id "map-control-${mapId}" not found in DOM`);
                    }
                    console.log(`[Dashboard] Map control element found: map-control-${mapId}`);
                    
                    // Initialize map control with retry
                    console.log(`[Dashboard] Initializing map control...`);
                    await initWithRetry(async () => {
                        await initMapControl(mapId, mapInstance);
                    }, 2, 1000, 'Map control initialization');
                    console.log(`[Dashboard] Map control initialized successfully`);
                    
                    // Initial refresh with retry
                    console.log(`[Dashboard] Performing initial marker refresh...`);
                    await initWithRetry(async () => {
                        await refreshMapMarkers(mapInstance, mapId);
                    }, 2, 1000, 'Marker refresh');
                    console.log(`[Dashboard] Initial markers refreshed successfully`);
                    
                    // Update status bar after refresh
                    await updateStatusBar();
                    
                    // Start sync scheduler (runs every 2 seconds after previous sync finishes)
                    const { startSyncScheduler, stopSyncScheduler } = await import("{{ url_for('static', filename='location-sync.js') }}");
                    startSyncScheduler();
                    window.stopSyncScheduler = stopSyncScheduler; // Store for cleanup
                    
                    // Start automatic map refresh every 10 seconds
                    console.log('[MapRefresh] Starting automatic map refresh (interval: 10s)');
                    let mapRefreshInterval = setInterval(async () => {
                        try {
                            console.log('[MapRefresh] Automatic refresh triggered');
                            await refreshMapMarkers(mapInstance, mapId);
                            // Update status bar after refresh
                            if (typeof window.updateStatusBar === 'function') {
                                await updateStatusBar();
                            }
                        } catch (error) {
                            console.error('[MapRefresh] Error during automatic refresh:', error);
                        }
                    }, 10000); // 10 seconds
                    
                    // Store interval ID for potential cleanup
                    window.mapRefreshInterval = mapRefreshInterval;
                    console.log('[Dashboard] Automatic refresh interval started');
                    
                } catch (error) {
                    console.error(`[Dashboard] Error initializing map features:`, error);
                    // Retry once after delay
                    console.log(`[Dashboard] Retrying map features initialization in 1 second...`);
                    setTimeout(async () => {
                        try {
                            await initMapFeatures();
                        } catch (retryError) {
                            console.error(`[Dashboard] Retry failed:`, retryError);
                        }
                    }, 1000);
                }
            }
            
            // Start initialization
            await initializeMapFeatures();
            console.log('[Dashboard] Dashboard initialization completed successfully');
            
        } catch (error) {
            console.error('[Dashboard] Error initializing dashboard map:', error);
            const mapContainer = document.getElementById('dashboard-map');
            if (mapContainer) {
                mapContainer.innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444;">' +
                    'Error loading map: ' + error.message +
                    '</div>';
            }
        }
        
        // Cleanup interval on page unload
        window.addEventListener('beforeunload', () => {
            if (window.mapRefreshInterval) {
                console.log('[MapRefresh] Stopping automatic map refresh');
                clearInterval(window.mapRefreshInterval);
                window.mapRefreshInterval = null;
            }
            if (window.stopSyncScheduler) {
                console.log('[LocationSync] Stopping sync scheduler');
                window.stopSyncScheduler();
            }
        });
        
        // Deep sync (last 3 hours)
        window.triggerDeepSync = async function() {
            const button = document.getElementById('deepSyncButton');
            const progress = document.getElementById('debugProgress');
            const status = document.getElementById('debugStatus');
            const details = document.getElementById('debugDetails');
            
            button.disabled = true;
            button.textContent = 'Syncing...';
            progress.classList.remove('hidden');
            status.textContent = 'Deep syncing with all nodes (last 3 hours)...';
            details.textContent = '';
            
            try {
                const now = Date.now();
                const threeHoursAgo = now - (3 * 60 * 60 * 1000); // 3 hours in milliseconds
                
                const result = await deepSyncAllNodes(threeHoursAgo, now);
                
                status.textContent = `Deep sync completed: ${result.synced}/${result.total} nodes`;
                details.textContent = `Total locations: ${result.totalCount}. `;
                
                if (result.errors.length > 0) {
                    details.textContent += `Errors: ${result.errors.length}`;
                    console.error('Deep sync errors:', result.errors);
                }
                
                // Refresh displays
                if (typeof window.updateStatusBar === 'function') {
                    await window.updateStatusBar();
                }
                const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
                if (typeof refreshMapMarkers === 'function' && window.mapInstance && window.mapId) {
                    await refreshMapMarkers(window.mapInstance, window.mapId);
                }
                
            } catch (error) {
                status.textContent = 'Deep sync failed';
                details.textContent = error.message || String(error);
                console.error('Deep sync error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Deep Sync (Last 3 Hours)';
                
                // Hide progress after 3 seconds
                setTimeout(() => {
                    progress.classList.add('hidden');
                }, 3000);
            }
        };
        
        // Clear local state (IndexedDB)
        window.clearLocalState = async function() {
            const button = document.getElementById('clearDbButton');
            const progress = document.getElementById('debugProgress');
            const status = document.getElementById('debugStatus');
            const details = document.getElementById('debugDetails');
            
            if (!confirm('Are you sure you want to clear all local state? This will delete all synced location data from IndexedDB.')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = 'Clearing...';
            progress.classList.remove('hidden');
            status.textContent = 'Clearing local state...';
            details.textContent = '';
            
            try {
                // Clear all tables in IndexedDB
                await db.transaction('rw', db.locations, db.latest_locations, db.node_sync, db.map_mode, async () => {
                    await db.locations.clear();
                    await db.latest_locations.clear();
                    await db.node_sync.clear();
                    // Keep map_mode (don't clear map configurations)
                    // await db.map_mode.clear();
                });
                
                status.textContent = 'Local state cleared successfully';
                details.textContent = 'All location data and sync states have been cleared from IndexedDB.';
                
                // Refresh displays
                if (typeof window.updateStatusBar === 'function') {
                    await window.updateStatusBar();
                }
                const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
                if (typeof refreshMapMarkers === 'function' && window.mapInstance && window.mapId) {
                    await refreshMapMarkers(window.mapInstance, window.mapId);
                }
                
            } catch (error) {
                status.textContent = 'Clear failed';
                details.textContent = error.message || String(error);
                console.error('Clear error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Clear Local State';
                
                // Hide progress after 3 seconds
                setTimeout(() => {
                    progress.classList.add('hidden');
                }, 3000);
            }
        };
    })();
</script>
{% endblock %}

