{% extends "base.html" %}

{% block title %}Dashboard - Nexum Mesh Messaging{% endblock %}

{% block extra_css %}
<style>
    #dashboard-map {
        width: 100% !important;
        height: calc(100vh - 200px) !important;
        min-height: 600px !important;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Mesh Network Dashboard</h2>
        <p class="mt-2 text-sm text-gray-600">View and manage location data from mesh network nodes</p>
    </div>

    <!-- Map Container -->
    <div class="bg-white shadow rounded-lg p-4">
        <!-- Status Bar -->
        <div id="status-bar" class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <div id="status-bar-content" class="flex flex-wrap items-center gap-4 md:gap-6">
                <!-- Status items will be dynamically inserted here -->
                <div class="text-sm text-gray-500">Loading...</div>
            </div>
        </div>
        
        <div id="dashboard-map" style="position: relative; width: 100%; height: calc(100vh - 200px); min-height: 600px;">
        </div>
        
        <!-- Map Controls - Below Map -->
        <div class="mt-4">
            {% set map_id = 'default' %}
            {% include 'components/map_control.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load MapLibre GL JS first -->
<script src="{{ url_for('static', filename='maplibre-gl.js') }}"></script>
<script type="module">
    (async function() {
        // Wait for maplibregl if not yet available
        while (typeof maplibregl === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        const { initMap } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { initMapControl } = await import("{{ url_for('static', filename='map-control.js') }}");
        const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { getLocationStats } = await import("{{ url_for('static', filename='location-reader.js') }}");
        
        // Update status bar with entity counts
        async function updateStatusBar() {
            try {
                const stats = await getLocationStats();
                const statusBar = document.getElementById('status-bar');
                const counts = stats.by_entity_type || {};
                
                // Entity types with their display names and icons
                const entityTypes = [
                    { type: 'responder', label: 'Responder', icon: '/assets/images/responder.png' },
                    { type: 'civilian', label: 'Civilian', icon: '/assets/images/civilian.png' },
                    { type: 'incident', label: 'Incident', icon: '/assets/images/incident.png' },
                    { type: 'resource', label: 'Resource', icon: '/assets/images/resource.png' },
                    { type: 'hazard', label: 'Hazard', icon: '/assets/images/hazard.png' }
                ];
                
                // Build status bar HTML
                const items = entityTypes.map(entity => {
                    const count = counts[entity.type] || 0;
                    return `
                        <div class="flex items-center gap-2">
                            <img src="${entity.icon}" alt="${entity.label}" class="w-5 h-5 object-contain" />
                            <span class="font-medium text-gray-900">${entity.label}</span>
                            <span class="text-gray-600">${count}</span>
                        </div>
                    `;
                }).join('');
                
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = items || '<div class="text-sm text-gray-500">No locations found</div>';
                }
                
            } catch (error) {
                console.error('Error updating status bar:', error);
                const statusBarContent = document.getElementById('status-bar-content');
                if (statusBarContent) {
                    statusBarContent.innerHTML = '<div class="text-sm text-red-500">Error loading status</div>';
                }
            }
        }
        
        try {
            // Initial status bar update
            await updateStatusBar();
            
            // Initialize map with mapId
            const mapInstance = await initMap({
                containerId: 'dashboard-map',
                showControls: true,
                mapId: 'default'
            });
            
            // Make updateStatusBar globally accessible so map control can call it
            window.updateStatusBar = updateStatusBar;
            
            // Wait for map to load
            mapInstance.once('load', async () => {
                console.log('Map loaded, initializing map controls...');
                // Initialize map control (component already rendered in template)
                await initMapControl('default', mapInstance);
                
                // Initial refresh
                await refreshMapMarkers(mapInstance, 'default');
                
                // Update status bar after refresh
                await updateStatusBar();
            });
           
            
        } catch (error) {
            console.error('Error initializing dashboard map:', error);
            document.getElementById('dashboard-map').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444;">' +
                'Error loading map: ' + error.message +
                '</div>';
        }
    })();
</script>
{% endblock %}

