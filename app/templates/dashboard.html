{% extends "base.html" %}

{% block title %}Dashboard - Nexum Mesh Messaging{% endblock %}

{% block extra_css %}
<style>
    #dashboard-map {
        width: 100% !important;
        height: calc(100vh - 200px) !important;
        min-height: 600px !important;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-3xl font-bold text-gray-900">Mesh Network Dashboard</h2>
        <p class="mt-2 text-sm text-gray-600">View and manage location data from mesh network nodes</p>
    </div>

    <!-- Map Container -->
    <div class="bg-white shadow rounded-lg p-4">
        <div id="dashboard-map" style="position: relative; width: 100%; height: calc(100vh - 200px); min-height: 600px;">
            {% set map_id = 'default' %}
            {% include 'components/map_control.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load MapLibre GL JS first -->
<script src="{{ url_for('static', filename='maplibre-gl.js') }}"></script>
<script type="module">
    (async function() {
        // Wait for maplibregl if not yet available
        while (typeof maplibregl === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        const { initMap } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        const { initMapControl } = await import("{{ url_for('static', filename='map-control.js') }}");
        const { refreshMapMarkers } = await import("{{ url_for('static', filename='maplibre-map.js') }}");
        
        try {
            // Initialize map with mapId
            const mapInstance = await initMap({
                containerId: 'dashboard-map',
                showControls: true,
                mapId: 'dashboard-map'
            });
            
            // Wait for map to load
           
            console.log('Map loaded, initializing map controls...');
            // Initialize map control (component already rendered in template)
            await initMapControl('default', mapInstance);
            
            // Initial refresh
            await refreshMapMarkers(mapInstance, 'default');
           
            
        } catch (error) {
            console.error('Error initializing dashboard map:', error);
            document.getElementById('dashboard-map').innerHTML = 
                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444;">' +
                'Error loading map: ' + error.message +
                '</div>';
        }
    })();
</script>
{% endblock %}

